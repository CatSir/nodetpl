/*!
 * nodetpl v2.2.4
 * Best javascript template engine
 * https://www.nodetpl.com
 *
 * Copyright 2012-2015 pillys@163.com
 * Released under the MIT license
 */
(function(root,factory){"use strict";if(typeof define==="function"&&define.amd){define("nodetpl",[],factory)}else if(typeof define==="function"&&define.cmd){define(factory)}else if(typeof exports==="object"){module.exports=factory()}else{root.nodetpl=factory()}})(this,function(require,exports,module){if(!String.prototype.trim)String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")};function NodeTpl(){this.version="2.2.4";this.ie6=window.VBArray&&!window.XMLHttpRequest;this.guid=function(){return"NTGUID__"+(this.guid._counter++).toString(36)};this.dguid=function(){return"NTDGUID__"+(this.dguid._counter++).toString(36)};this.rguid=function(){return"NTRGUID__"+(this.rguid._counter++).toString(36)};this.guid._counter=1;this.dguid._counter=1;this.rguid._counter=1;this._data={};this._tpls={};this._cache={};this.options={base:"",vars:{root:'$("#~")'},openTag:"<?",closeTag:"?>"};return this}NodeTpl.prototype.config=function(options){if(options){this.extend(this.options,options);return this}else{return this.options}};NodeTpl.prototype.extend=function(){var that=this,options,name,src,copy,copyIsArray,clone,target=arguments[0],i=1,length=arguments.length,deep=false;var hasOwn=Object.prototype.hasOwnProperty;var toStr=Object.prototype.toString;var isArray=function isArray(arr){if(typeof Array.isArray==="function"){return Array.isArray(arr)}return toStr.call(arr)==="[object Array]"};var isPlainObject=function isPlainObject(obj){if(!obj||toStr.call(obj)!=="[object Object]"){return false}var hasOwnConstructor=hasOwn.call(obj,"constructor");var hasIsPrototypeOf=obj.constructor&&obj.constructor.prototype&&hasOwn.call(obj.constructor.prototype,"isPrototypeOf");if(obj.constructor&&!hasOwnConstructor&&!hasIsPrototypeOf){return false}var key;for(key in obj){}return typeof key==="undefined"||hasOwn.call(obj,key)};if(typeof target==="boolean"){deep=target;target=arguments[1]||{};i=2}else if(typeof target!=="object"&&typeof target!=="function"||target==null){target={}}for(;i<length;++i){options=arguments[i];if(options!=null){for(name in options){src=target[name];copy=options[name];if(target!==copy){if(deep&&copy&&(isPlainObject(copy)||(copyIsArray=isArray(copy)))){if(copyIsArray){copyIsArray=false;clone=src&&isArray(src)?src:[]}else{clone=src&&isPlainObject(src)?src:{}}target[name]=that.extend(deep,clone,copy)}else if(typeof copy!=="undefined"){target[name]=copy}}}}}return target};NodeTpl.prototype._split=function(str,separator,limit){if(Object.prototype.toString.call(separator)!=="[object RegExp]"){return str.split(separator,limit)}var output=[],lastLastIndex=0,flags=(separator.ignoreCase?"i":"")+(separator.multiline?"m":"")+(separator.sticky?"y":""),separator=RegExp(separator.source,flags+"g"),_compliantExecNpcg=/()??/.exec("")[1]===undefined,separator2,match,lastIndex,lastLength;str=str+"";if(!_compliantExecNpcg)separator2=RegExp("^"+separator.source+"$(?!\\s)",flags);if(limit===undefined||+limit<0){limit=Infinity}else{limit=Math.floor(+limit);if(!limit)return[]}while(match=separator.exec(str)){lastIndex=match.index+match[0].length;if(lastIndex>lastLastIndex){output.push(str.slice(lastLastIndex,match.index));if(!_compliantExecNpcg&&match.length>1){match[0].replace(separator2,function(){for(var i=1;i<arguments.length-2;i++){if(arguments[i]===undefined)match[i]=undefined}})}if(match.length>1&&match.index<str.length)Array.prototype.push.apply(output,match.slice(1));lastLength=match[0].length;lastLastIndex=lastIndex;if(output.length>=limit)break}if(separator.lastIndex===match.index)separator.lastIndex++}if(lastLastIndex===str.length){if(lastLength||!separator.test(""))output.push("")}else{output.push(str.slice(lastLastIndex))}return output.length>limit?output.slice(0,limit):output};NodeTpl.prototype._getCurrentScript=function(){var doc=document,head,nodes;if(doc.currentScript){return doc.currentScript.src}var stack;try{a.b.c()}catch(e){stack=e.stack;if(!stack&&window.opera){stack=(String(e).match(/of linked script \S+/g)||[]).join(" ")}}if(stack){stack=stack.split(/[@ ]/g).pop();stack=stack[0]=="("?stack.slice(1,-1):stack;return stack.replace(/(:\d+)?:\d+$/i,"")}head=doc.head||doc.getElementsByTagName("head")[0];nodes=head.getElementsByTagName("script");for(var i=0,node;node=nodes[i++];){if(node.readyState==="interactive"){return node.className=node.src}}};NodeTpl.prototype._fixcss=function(css){var style=document.getElementById("nodetpl_css");if(!style){style=document.createElement("style");style.setAttribute("type","text/css");style.setAttribute("id","nodetpl_css");document.getElementsByTagName("head")[0].appendChild(style)}if(style.styleSheet){style.styleSheet.cssText+=css}else{style.appendChild(document.createTextNode(css))}};NodeTpl.prototype.css=function(css){if(!css){return""}if(this.ie6){var style=document.getElementById("nodetpl_css");if(!style){style=document.createElement("style");style.setAttribute("type","text/css");style.setAttribute("id","nodetpl_css");document.getElementsByTagName("head")[0].appendChild(style)}if(style.styleSheet){style.styleSheet.cssText+=css}else{style.appendChild(document.createTextNode(css))}return""}else{return"<style>"+css+"</style>\n"}};NodeTpl.prototype._template=function(html){var temp,list={},regExp=/<template(.*name=['"]([^'"]+)*)?\b[^>]*>([^<]*(?:(?!<\/template>)<[^<]*)*)<\/template>/gim;while(temp=regExp.exec(html)){if(temp[2]){list[temp[2]]=temp[3]}}list["main"]=list["main"]||html;return list};NodeTpl.prototype.render=function(html,data,callback){var that=this,hasCache=false,result,path;if(typeof html!=="string"){throw new TypeError}if(typeof data==="function"){callback=data,data={}}for(var i in that._cache){if(that._cache.hasOwnProperty(i)&&that._cache[i].html===html){path=i;result=that._cache[i].result;hasCache=true;break}}if(!hasCache){path=Math.random().toString();result=this.compile(path,html);new Function(result)();that._cache[path]={html:html,result:result}}if(typeof this._tpls[path]==="object"&&typeof this._tpls[path].main==="function"){result=this._tpls[path].main(data);typeof callback==="function"&&callback.call(this,result);return result}else{return null}};NodeTpl.prototype.update=function(){return this};NodeTpl.prototype.compile=function(path,html){if(typeof path!=="string"||typeof html!=="string"){throw new TypeError}return this._compile(path,this._fetch(html))};NodeTpl.prototype._load=function(url,callback){var that=this,d=document.createElement("script");d.type="text/javascript";if(d.readyState){d.onreadystatechange=function(){if(that.ie6&&!this.getAttribute("initialized")){document.getElementsByTagName("head")[0].appendChild(d);this.setAttribute("initialized",true)}if(this.readyState=="loaded"||this.readyState=="complete"){this.onreadystatechange=null;callback&&callback.call(that)}};d.src=url;!this.ie6&&document.getElementsByTagName("head")[0].appendChild(d)}else{d.src=url;d.onload=function(){callback&&callback.call(that)};document.getElementsByTagName("head")[0].appendChild(d)}return this};NodeTpl.prototype.get=function(url,data,callback){var that=this,path,cache=that._tpls,store,doCallback;url=url.trim();if(!/^(https?:|\/{2})/.test(url)){url=that.options.base+url}if(/^\/[^\/]/.test(url)){url="//"+location.host+url}if(/^\/{2}/.test(url)){url=location.protocol+url}if(!/\.js$/.test(url)){url=url+".js"}if(require&&require.async){require.async(url,function(init){init(that);callback(that._tpls[url].main(data))});return this}path=url.replace(/^((https?:)?\/{2}[^\/]+)/,"");if(!path){return false}store=cache[url]||cache[path];if(typeof data==="function"){callback=data;data={}}doCallback=function(){if(typeof callback==="function"){if(data===false){callback.call(that,{render:function(_data){return store.main(_data||{})}})}else{callback.call(that,store.main(data))}}};if(typeof store==="object"&&typeof store.main==="function"){doCallback()}else{that._load(url,function(){store=cache[url]||cache[path];if(typeof store==="object"&&typeof store.main==="function"){doCallback()}})}};NodeTpl.prototype._fetch=function(html){var that=this,list,htmlCode="",jsCode="",cssCode="",cache={};var jsExp=/<script\b[^>]*>([^<]*(?:(?!<\/script>)<[^<]*)*)<\/script>/gim,cssExp=/<style\b[^>]*>([^<]*(?:(?!<\/style>)<[^<]*)*)<\/style>/gim;list=this._template(html);for(var tplname in list){if(!list.hasOwnProperty(tplname)){continue}cssCode="";jsCode="";htmlCode=list[tplname];if(!htmlCode){continue}htmlCode=htmlCode.replace(cssExp,function($,$1){return cssCode+="\n"+$1,""}).replace(jsExp,function($,$1){return jsCode+="\n"+$1,""});cache[tplname]={css:that._css(cssCode.trim(),tplname),html:that._html(htmlCode.trim(),tplname),js:that._js(jsCode.trim(),tplname)}}return cache};NodeTpl.prototype._css=function(content,tplname){if(content){content=content.replace(/'/g,"\\'");content="    css += '"+content.replace(/\/\*(.|\n)*?\*\/|\r?\n/gi,"").replace(/([a-zA-Z0-9_\-#*\.:\s,\(\)'"<>=]*)(\{)/gi,function(a,b,c){var sguid;if(tplname==="main"){sguid="guid"}else{sguid="guid + dguid"}b=b.trim();if(b===""){return"#' + "+sguid+" + '"+c}else{var _b=b.split(",");for(var i=0;i<_b.length;i++){_b[i]=_b[i].trim();_b[i]="';\r\n    css += '#' + "+sguid+" + '"+(_b[i].indexOf(":")===0?"":" ")+_b[i]}return _b.join(",")+c}});content+="';"}return content};NodeTpl.prototype._js=function(content,tplname){var jsarr;if(content){jsarr=this._split(content,/\r?\n/g);for(var i=0;i<jsarr.length;i++){if(!jsarr[i])continue;jsarr[i]="    _ += '"+jsarr[i].replace(/\\/g,"\\\\").replace(/\'/g,"\\'").replace(/\r\n/g,"\n").replace(/\n/g,"\\n").replace(/(^|[^\.])include\(([^\)]*)\)/gi,function(a,b,c){var _c=(c||"").split(",");_c.map(function(value,index){_c[index]=_c[index].trim()});return b+"$TPLS["+_c[0]+"]("+(_c.length>1?_c[1]:"$DATA")+", \"'+ guid +'\")"})+"\\n';\n"}content=jsarr.join("")}return content};NodeTpl.prototype._html=function(content,tplname){var that=this,html,tagExp,openTag,closeTag,getTag;if(content){getTag=function(tag){return tag.replace(/([\$\(\)\*\+\.\[\]\?\\\^\{\}\|])/g,"\\$1")};openTag=getTag(that.options.openTag);closeTag=getTag(that.options.closeTag);html=this._split(content,new RegExp("("+openTag+"[\\s\\S]*?"+closeTag+")"));for(var i=0;i<html.length;i++){if(!html[i])continue;tagExp=new RegExp(openTag+"([\\s\\S]*?)"+closeTag,"igm");if(tagExp.test(html[i])){html[i]=html[i].replace(tagExp,"$1");html[i]=html[i].replace(/@([a-zA-Z\$_]+)/gim,"$DATA.$1");html[i]=html[i].replace(/print\((.*?)\);/gim,"    template.push(($1) || '');\n");if(html[i].indexOf("=")===0){html[i]="    _ += (("+html[i].substring(1)+") == null ? '' : ("+html[i].substring(1)+"));"}}else{html[i]="\n    _ += '"+html[i].replace(/\\/g,"\\\\").replace(/\'/g,"\\'").replace(/\r\n/g,"\n").replace(/\n/g,"\\n")+"';\n"}}content=html.join("");content=content.replace(/\$ROOT/gim,"'+ guid +'");content=content.replace(/\$SUBROOT/gim,"'+ guid + dguid +'")}content="\nwith($DATA || {}){\n"+content+"\n}\n";return content};NodeTpl.prototype._compile=function(path,cache){var temp,html="",list=[];for(var i in cache){if(!cache.hasOwnProperty(i)){continue}temp="";temp+='  "'+i+'": function($DATA, guid){\n';temp+="    var _ = '', css = '', dguid = N.dguid();\n";temp+="    guid = guid || N.guid();\n";if(cache[i].css){temp+=cache[i].css+"\n";temp+="    _ += N.css(css);"}if(cache[i].html){temp+=cache[i].html}if(cache[i].js){temp+="    _ += '<script>';\n";temp+="    _ += '(function(window, document, undefined){\\n';\n";temp+="    _ += '  var ROOT, $ROOT, SUBROOT, $SUBROOT, $TPLS, $DATA;\\n';\n";temp+="    _ += '  ROOT = document.getElementById(\"'+ guid +'\");\\n';\n";temp+="    _ += '  SUBROOT = document.getElementById(\"'+ guid + dguid +'\");\\n';\n";temp+="    _ += '  $TPLS = nodetpl._tpls[\"'+ PATH +'\"];\\n';\n";temp+="    _ += '  $DATA = nodetpl._data[\"'+ dguid +'\"];\\n';\n";temp+="    _ += '  try{\\n';\n";temp+="    _ += '    $ROOT = '+ N.options.vars.root.replace(/~/, guid) + ';\\n';\n";temp+="    _ += '    $SUBROOT = '+ N.options.vars.root.replace(/~/, guid + dguid) + ';\\n';\n";temp+="    _ += '  } catch(e) { }\\n';\n";temp+=cache[i].js;temp+="    _ += '})(window, document);\\n';\n";temp+="    _ += 'delete nodetpl._data[\"'+ dguid +'\"];\\n';\n";temp+="    _ += '</script>\\n';\n"}temp+="    $DATA && (N._data[dguid] = $DATA);\n";temp+="    return _;\n";temp+="  }";list.push(temp)}html+="(function(root, factory) {\n";html+=" if (typeof define === 'function' && (define.amd || define.cmd)) {\n";html+="   define(factory);\n";html+=" } else if (typeof exports === 'object') {\n";html+="   module.exports = factory();\n";html+=" } else {\n";html+="   factory()(window.nodetpl);\n";html+=" }\n";html+="}(this, function(require, exports, module) {\n";html+="return function(N, undefined){\n";html+="  var PATH = '"+path+"';\n";html+="  if(!N || !N._tpls) return false;\n";html+="  if (PATH === '') {\n";html+="    if (module && module.uri) {\n";html+="      PATH = module.uri;\n";html+="    } else if (N._getCurrentScript) {\n";html+="      PATH = N._getCurrentScript();\n";html+="    }\n";html+="  }\n";html+="  N._tpls[PATH] = N._tpls[PATH] ||\n{\n";html+=list.join(",\n");html+="\n};";html+="\n};\n";html+="}));";return html};return new NodeTpl});